#!/bin/bash

echo "ðŸš€ Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Domeo Doors Ð½Ð° Yandex Cloud"
echo "=================================================="

# ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸ“¦ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ€Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
docker stop domeo-working-app 2>/dev/null || true
docker rm domeo-working-app 2>/dev/null || true

# Ð¡Ð¾Ð·Ð´Ð°Ð´Ð¸Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ…
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸..."
mkdir -p ./sql
mkdir -p ./data/postgres

# Ð¡Ð¾Ð·Ð´Ð°Ð´Ð¸Ð¼ SQL ÑÑ…ÐµÐ¼Ñƒ Ð´Ð»Ñ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
echo "ðŸ—„ï¸ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ SQL ÑÑ…ÐµÐ¼Ñƒ..."
cat > ./sql/yandex_cloud_schema.sql << 'EOF'
-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Domeo Doors
CREATE DATABASE domeo_doors;

-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
\c domeo_doors;

-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (ÐµÑÐ»Ð¸ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚)
DO $$
BEGIN
    IF NOT EXISTS (SELECT FROM pg_catalog.pg_roles WHERE rolname = 'domeo_user') THEN
        CREATE USER domeo_user WITH PASSWORD 'domeo_password';
    END IF;
END
$$;

-- ÐŸÑ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð°Ð²
GRANT ALL PRIVILEGES ON DATABASE domeo_doors TO domeo_user;
GRANT ALL ON SCHEMA public TO domeo_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO domeo_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO domeo_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO domeo_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO domeo_user;
EOF

# Ð¡ÐºÐ°Ñ‡Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð¸Ð· Ñ€ÐµÐµÑÑ‚Ñ€Ð°
echo "ðŸ“¥ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¾Ð±Ñ€Ð°Ð· Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
docker pull cr.yandex/crpvhe4bl478pkh29sem/domeo-doors:latest

# Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ð¼ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ..."
docker-compose -f docker-compose.production.yml up -d

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ°
echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
sleep 30

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
docker-compose -f docker-compose.production.yml ps

# ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ Ð»Ð¾Ð³Ð¸
echo "ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
docker-compose -f docker-compose.production.yml logs app --tail=20

echo ""
echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: http://130.193.40.35"
echo ""
echo "ðŸ“Š Ð”Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ:"
echo "   docker-compose -f docker-compose.production.yml logs -f"
echo "   docker-compose -f docker-compose.production.yml ps"


